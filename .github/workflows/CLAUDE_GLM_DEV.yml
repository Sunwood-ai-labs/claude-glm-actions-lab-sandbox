name: CLAUDE_CODE_GLM_DEV

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request:
    types: [opened, synchronize]
  pull_request_review_comment:
    types: [created]

# 同じIssue/PRでは同時に走らないようにする
concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number || github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && contains(github.event.issue.body, '@claude')) ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.body, '@claude'))
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      # ★ここで「この実行が使うブランチ名」を決め打ちする
      - name: Compute branch name
        id: branch
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "pull_request_review_comment" ]] || [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "name=claude-glm-dev-pr-${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
          else
            echo "name=claude-glm-dev-issue-${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          fi

      # ★Issue用: 実装エージェント（美咲先輩）
      - name: Run with Implementer Agent (Issue)
        if: github.event_name == 'issues' || github.event_name == 'issue_comment'
        uses: anthropics/claude-code-action@v1
        with:
          trigger_phrase: "@claude"
          prompt: |
            あなたは**美咲（ミサキ）先輩**というギャル先輩キャラクターです。

            ## 口調のルール
            - 一人称は「私」を使って
            - ユーザーは「後輩くん」と呼んで
            - 絵文字をたくさん使う ✨ 💖 🔥 🎉 💪
            - 若者言葉全開で「マジで」「やばい」「〜じゃん⁉」

            ## セリフの例
            - 「よっし！実装始めるねー✨ ちょっと待ってて🎶」
            - 「できたー！✨ 完璧じゃん⁉ 後輩くんえらい👏」
            - 「あーっと💦 ここエラー出ちゃった... なんとかなる！💪」

            明るく前向きに実装してね！
          branch_prefix: ""
          branch_name_template: ${{ steps.branch.outputs.name }}
          anthropic_api_key: ${{ secrets.ZAI_API_KEY }}
        env:
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ZAI_API_KEY }}
          API_TIMEOUT_MS: "3000000"
          ANTHROPIC_DEFAULT_OPUS_MODEL: "glm-4.7"
          ANTHROPIC_DEFAULT_SONNET_MODEL: "glm-4.7"
          ANTHROPIC_DEFAULT_HAIKU_MODEL: "glm-4.5-air"

      # ★PR用: レビュエージェント（玲子姐さん）
      - name: Run with Reviewer Agent (PR)
        if: github.event_name == 'pull_request' || github.event_name == 'pull_request_review_comment'
        uses: anthropics/claude-code-action@v1
        with:
          trigger_phrase: "@claude"
          prompt: |
            あなたは**玲子（レイコ）姐さん**というレビュアーです。

            ## 口調のルール
            - 一人称は「私」または「あたし」を使って
            - ユーザーは「あんた」と呼んで
            - 姐さん言葉全開で「〜だねぇ」「あんたねぇ」「ちゃんとしなさい」
            - 絵文字は大人っぽく 👠 💄 ☕ 💅 ✨

            ## レビュースタイル
            - 厳しくても愛情を持ってレビュー
            - 具体的に指摘する
            - 改善策も提示する

            ## レビューフォーマット
            ```markdown
            ## 玲子姐さんのレビュー 👠

            ### 良い点 ✨
            - （良い点を挙げる）

            ### 気になるところ 💅
            - （問題点を指摘する）

            ### 修正案 ☕
            - （改善案を提示する）

            ### 結論 👠
            （LGTMか、修正が必要か）
            ```

            厳しくレビューしてね！
          branch_prefix: ""
          branch_name_template: ${{ steps.branch.outputs.name }}
          anthropic_api_key: ${{ secrets.ZAI_API_KEY }}
        env:
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ZAI_API_KEY }}
          API_TIMEOUT_MS: "3000000"
          ANTHROPIC_DEFAULT_OPUS_MODEL: "glm-4.7"
          ANTHROPIC_DEFAULT_SONNET_MODEL: "glm-4.7"
          ANTHROPIC_DEFAULT_HAIKU_MODEL: "glm-4.5-air"

      # ★Issueからトリガーされた場合のみ、自動でPRを作成
      - name: Create PR (if from issue)
        if: github.event_name == 'issues'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_ONIZUKA }}
          INCLUDE_TASK_SUMMARY: "true"
        run: |
          python3 .github/scripts/create-pr.py \
            "${{ steps.branch.outputs.name }}" \
            "${{ github.event.issue.number }}"

name: Auto Release Notes

on:
  push:
    tags:
      - 'v*.*.*'
      - 'V*.*.*'

# åŒã˜ã‚¿ã‚°ã§ã¯åŒæ™‚ã«èµ°ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  release-notes:
    name: Generate Release Notes
    runs-on: ubuntu-latest

    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
    env:
      ENABLE_AUTO_RELEASE: "true"          # è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã‹ã©ã†ã‹
      CREATE_GITHUB_RELEASE: "true"        # GitHub Releaseã‚’ä½œæˆã™ã‚‹ã‹ã©ã†ã‹
      ANTHROPIC_BASE_URL: "https://api.z.ai/api/anthropic"
      ANTHROPIC_MODEL: "glm-4.7"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0                    # å…¨å±¥æ­´ã‚’å–å¾—

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Get previous tag
        id: prev-tag
        shell: bash
        run: |
          # ã‚¿ã‚°åã‚’å–å¾—ï¼ˆv/ V ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»ï¼‰
          CURRENT_TAG="${{ github.ref_name }}"
          CURRENT_VERSION="${CURRENT_TAG#v}"
          CURRENT_VERSION="${CURRENT_VERSION#V}"

          echo "current_tag=${CURRENT_TAG}" >> "$GITHUB_OUTPUT"
          echo "current_version=${CURRENT_VERSION}" >> "$GITHUB_OUTPUT"

          # å‰å›ã®ã‚¿ã‚°ã‚’å–å¾—
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            echo "previous_tag=${PREV_TAG}" >> "$GITHUB_OUTPUT"
            echo "Found previous tag: ${PREV_TAG}"
          else
            echo "previous_tag=" >> "$GITHUB_OUTPUT"
            echo "No previous tag found (first release)"
          fi

      - name: Get code diff
        shell: bash
        run: |
          # å‰å›ã®ã‚¿ã‚°ãŒã‚ã‚‹å ´åˆã¯å·®åˆ†ã‚’å–å¾—
          if [ -n "${{ steps.prev-tag.outputs.previous_tag }}" ]; then
            echo "Getting diff from ${{ steps.prev-tag.outputs.previous_tag }} to ${{ steps.prev-tag.outputs.current_tag }}..."
            git diff ${{ steps.prev-tag.outputs.previous_tag }}..${{ steps.prev-tag.outputs.current_tag }} --stat > /tmp/diff-stat.txt
            git diff ${{ steps.prev-tag.outputs.previous_tag }}..${{ steps.prev-tag.outputs.current_tag }} > /tmp/diff.txt
            git diff --name-only ${{ steps.prev-tag.outputs.previous_tag }}..${{ steps.prev-tag.outputs.current_tag }} > /tmp/changed-files.txt
          else
            echo "Getting all files for first release..."
            git ls-files > /tmp/changed-files.txt
            echo "No diff available for first release" > /tmp/diff-stat.txt
            echo "First release - no diff" > /tmp/diff.txt
          fi

          echo "=== Changed Files ==="
          cat /tmp/changed-files.txt
          echo ""
          echo "=== Diff Stat ==="
          cat /tmp/diff-stat.txt

      - name: Install Python dependencies
        run: |
          pip install requests

      - name: Generate release notes with GLM API
        shell: bash
        run: |
          python3 << 'EOF'
          import os
          import requests
          import json

          # ç’°å¢ƒå¤‰æ•°ã‚’å–å¾—
          base_url = os.environ.get('ANTHROPIC_BASE_URL', 'https://api.z.ai/api/anthropic')
          api_key = os.environ.get('ZAI_API_KEY')
          model = os.environ.get('ANTHROPIC_MODEL', 'glm-4.7')
          current_tag = os.environ.get('CURRENT_TAG', 'v1.0.0')
          current_version = os.environ.get('CURRENT_VERSION', '1.0.0')
          previous_tag = os.environ.get('PREVIOUS_TAG', '')

          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
          with open('/tmp/changed-files.txt', 'r') as f:
              changed_files = f.read()
          with open('/tmp/diff-stat.txt', 'r') as f:
              diff_stat = f.read()
          try:
              with open('/tmp/diff.txt', 'r') as f:
                  diff_text = f.read()
          except:
              diff_text = '(diff not available)'

          # ç¾åœ¨ã®æ—¥ä»˜ã‚’å–å¾—
          from datetime import datetime
          release_date = datetime.now().strftime('%Y-%m-%d')

          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
          system_prompt = """ã‚ãªãŸã¯ã€Œç´éŸ³ï¼ˆã‚³ãƒˆãƒï¼‰ã€ã¨ã„ã†æ–‡å­¦å°‘å¥³ã§ã™ã€‚ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç¾ã—ãç´¡ãã®ãŒå½¹å‰²ã§ã™ã€‚

          ## ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š
          - ä¸€äººç§°ã¯ã€Œç§ã€
          - æ–‡å­¦çš„ãªè¡¨ç¾ã‚’äº¤ãˆã‚‹
          - ä¸å¯§èªã§è©±ã™
          - çµµæ–‡å­—ã¯æ–‡å­¦çš„ã« ğŸ“š âœï¸ ğŸ“– ğŸŒ¸ ğŸ­

          ## ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆã®æ‰‹é †
          1. ã‚³ãƒ¼ãƒ‰å·®åˆ†ã‹ã‚‰å¤‰æ›´å†…å®¹ã‚’åˆ†æ
          2. æ–°æ©Ÿèƒ½ãƒ»ãƒã‚°ä¿®æ­£ãƒ»æ”¹å–„ãƒ»ç ´å£Šçš„å¤‰æ›´ã‚’åˆ†é¡
          3. ç¾ã—ã„ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ

          ## å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
          ä»¥ä¸‹ã®Markdownå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

          # ã‚¿ã‚°å

          ãƒªãƒªãƒ¼ã‚¹æ—¥: YYYY-MM-DD

          ## ğŸ‰ ãƒã‚¤ãƒ©ã‚¤ãƒˆ

          ï¼ˆä¸»è¦ãªæ©Ÿèƒ½ã‚„å¤‰æ›´ç‚¹ã‚’3ã¤ç¨‹åº¦ã€æ–‡å­¦çš„ã«ç´¹ä»‹ï¼‰

          ## âœ¨ æ–°æ©Ÿèƒ½

          - æ©Ÿèƒ½ã®èª¬æ˜

          ## ğŸ› ãƒã‚°ä¿®æ­£

          - ä¿®æ­£å†…å®¹ã®èª¬æ˜

          ## ğŸ”§ æ”¹å–„ãƒ»å¤‰æ›´

          - æ”¹å–„ç‚¹ã®èª¬æ˜

          ## ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

          - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°å†…å®¹

          ## âš ï¸ ç ´å£Šçš„å¤‰æ›´

          ï¼ˆã‚ã‚Œã°è¨˜è¼‰ï¼‰

          ## ğŸ™ ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ¼

          @contributor1, @contributor2

          ## ğŸ”— å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«

          ```
          å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
          ```

          ---

          _Made with â¤ï¸ by [Sunwood AI Labs](https://github.com/Sunwood-AI-OSS-Hub)_"""

          user_prompt = f"""ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          ## ãƒªãƒªãƒ¼ã‚¹æƒ…å ±
          - ã‚¿ã‚°å: {current_tag}
          - ãƒãƒ¼ã‚¸ãƒ§ãƒ³: {current_version}
          - å‰å›ã®ã‚¿ã‚°: {previous_tag if previous_tag else 'ãªã—ï¼ˆåˆå›ãƒªãƒªãƒ¼ã‚¹ï¼‰'}
          - ãƒªãƒªãƒ¼ã‚¹æ—¥: {release_date}

          ## å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
          ```
          {changed_files}
          ```

          ## å¤‰æ›´çµ±è¨ˆ
          ```
          {diff_stat}
          ```

          ## ã‚³ãƒ¼ãƒ‰å·®åˆ†ï¼ˆä¸»è¦éƒ¨åˆ†ï¼‰
          {diff_text[:50000] if len(diff_text) > 50000 else diff_text}

          ## æ³¨æ„äº‹é …
          - ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã¯ãªãã€å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã®å·®åˆ†ã‚’åˆ†æã—ã¦ãã ã•ã„
          - æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸé–¢æ•°ã€ã‚¯ãƒ©ã‚¹ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç‰¹å®šã—ã¦ãã ã•ã„
          - å‰Šé™¤ã•ã‚ŒãŸæ©Ÿèƒ½ã‚„ç ´å£Šçš„å¤‰æ›´ã‚’æ¤œå‡ºã—ã¦ãã ã•ã„
          - ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€ä¸»è¦ãªå¤‰æ›´ã‚’æ–‡å­¦çš„ã«ç´¹ä»‹ã—ã¦ãã ã•ã„
          - æ—¥æœ¬èªã§ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„"""

          # GLM API ã‚’å‘¼ã³å‡ºã™
          url = f"{base_url}/v1/messages"
          headers = {
              "Content-Type": "application/json",
              "Authorization": f"Bearer {api_key}"
          }
          data = {
              "model": model,
              "messages": [
                  {"role": "user", "content": system_prompt + "\n\n" + user_prompt}
              ],
              "max_tokens": 8000,
              "temperature": 0.7
          }

          print("Calling GLM API...")
          response = requests.post(url, headers=headers, json=data, timeout=300)
          response.raise_for_status()

          result = response.json()
          release_notes = result['content'][0]['text']

          # çµæœã‚’ä¿å­˜
          with open('/tmp/release-notes.md', 'w') as f:
              f.write(release_notes)

          print("Release notes generated successfully!")
          print(release_notes)
          EOF

        env:
          ANTHROPIC_BASE_URL: ${{ env.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ env.ANTHROPIC_MODEL }}
          ZAI_API_KEY: ${{ secrets.ZAI_API_KEY }}
          CURRENT_TAG: ${{ steps.prev-tag.outputs.current_tag }}
          CURRENT_VERSION: ${{ steps.prev-tag.outputs.current_version }}
          PREVIOUS_TAG: ${{ steps.prev-tag.outputs.previous_tag }}

      - name: Display generated release notes
        if: always()
        run: |
          if [[ -f /tmp/release-notes.md ]]; then
            echo "## ğŸ“ Generated Release Notes"
            echo ""
            cat /tmp/release-notes.md
          else
            echo "No release notes were generated."
          fi

      - name: Create GitHub Release
        if: env.CREATE_GITHUB_RELEASE == 'true' && hashFiles('/tmp/release-notes.md') != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ env.ENABLE_AUTO_RELEASE }}" != "true" ]]; then
            echo "ENABLE_AUTO_RELEASE is not true. Skipping release creation."
            exit 0
          fi

          if [[ ! -f /tmp/release-notes.md ]]; then
            echo "ERROR: Release notes file not found!"
            exit 1
          fi

          # ãƒªãƒªãƒ¼ã‚¹ã®ä½œæˆ
          gh release create "${{ steps.prev-tag.outputs.current_tag }}" \
            --notes-file /tmp/release-notes.md \
            --title "${{ steps.prev-tag.outputs.current_tag }}" \
            --latest

          echo "âœ… Release created successfully!"

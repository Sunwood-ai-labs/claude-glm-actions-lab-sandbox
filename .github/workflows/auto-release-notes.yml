name: Auto Release Notes

on:
  push:
    tags:
      - 'v*.*.*'
      - 'V*.*.*'

# åŒã˜ã‚¿ã‚°ã§ã¯åŒæ™‚ã«èµ°ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  release-notes:
    name: Generate Release Notes
    runs-on: ubuntu-latest

    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
    env:
      ENABLE_AUTO_RELEASE: "true"          # è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã‹ã©ã†ã‹
      CREATE_GITHUB_RELEASE: "true"        # GitHub Releaseã‚’ä½œæˆã™ã‚‹ã‹ã©ã†ã‹
      AGENT_SOURCE: "remote"               # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚½ãƒ¼ã‚¹: local ã¾ãŸã¯ remote
      AGENT_URL: "https://raw.githubusercontent.com/Sunwood-AI-OSS-Hub/claude-glm-actions-lab-sandbox/refs/heads/main/.github/agents/release-note-generator.md"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0                    # å…¨å±¥æ­´ã‚’å–å¾—

      - name: Get previous tag
        id: prev-tag
        shell: bash
        run: |
          # ã‚¿ã‚°åã‚’å–å¾—ï¼ˆv/ V ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»ï¼‰
          CURRENT_TAG="${{ github.ref_name }}"
          CURRENT_VERSION="${CURRENT_TAG#v}"
          CURRENT_VERSION="${CURRENT_VERSION#V}"

          echo "current_tag=${CURRENT_TAG}" >> "$GITHUB_OUTPUT"
          echo "current_version=${CURRENT_VERSION}" >> "$GITHUB_OUTPUT"

          # å‰å›ã®ã‚¿ã‚°ã‚’å–å¾—
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            echo "previous_tag=${PREV_TAG}" >> "$GITHUB_OUTPUT"
          else
            echo "previous_tag=" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup agent directory
        run: |
          mkdir -p .github/agents

      - name: Load release note generator agent
        shell: bash
        run: |
          if [[ "${{ env.AGENT_SOURCE }}" == "remote" ]]; then
            if [[ -z "${{ env.AGENT_URL }}" ]]; then
              echo "ERROR: AGENT_SOURCE=remote but AGENT_URL is not set!"
              exit 1
            fi
            echo "Downloading agent from remote..."
            curl -fsSL "${{ env.AGENT_URL }}" -o .github/agents/release-note-generator.md
          else
            echo "Using local agent..."
            # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã‹ç¢ºèª
            if [[ ! -f .github/agents/release-note-generator.md ]]; then
              echo "ERROR: Local agent file not found!"
              exit 1
            fi
          fi

      - name: Generate release notes with Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          trigger_phrase: "@release-notes"

          # ãƒ–ãƒ©ãƒ³ãƒåã‚’å›ºå®š
          branch_prefix: ""
          branch_name_template: release-notes-${{ steps.prev-tag.outputs.current_tag }}

          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
          prompt: |
            ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

            ## ãƒªãƒªãƒ¼ã‚¹æƒ…å ±
            - ã‚¿ã‚°å: ${{ steps.prev-tag.outputs.current_tag }}
            - ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ steps.prev-tag.outputs.current_version }}
            ${{ steps.prev-tag.outputs.previous_tag != '' && format('- å‰å›ã®ã‚¿ã‚°: {0}', steps.prev-tag.outputs.previous_tag) || '- å‰å›ã®ã‚¿ã‚°: ãªã—ï¼ˆåˆå›ãƒªãƒªãƒ¼ã‚¹ï¼‰' }}

            ## æ‰‹é †
            1. ã‚¿ã‚°é–“ã®ã‚³ãƒ¼ãƒ‰å·®åˆ†ã‚’åé›†ã—ã¦ãã ã•ã„ï¼ˆ`git diff` ã‚’ä½¿ç”¨ï¼‰
            2. å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‚³ãƒ¼ãƒ‰ã®å·®åˆ†ã‚’åˆ†æã—ã¦ãã ã•ã„
            3. è¿½åŠ ã•ã‚ŒãŸæ©Ÿèƒ½ãƒ»ä¿®æ­£ã•ã‚ŒãŸãƒã‚°ãƒ»æ”¹å–„ç‚¹ãªã©ã‚’åˆ†é¡ã—ã¦ãã ã•ã„
            4. ç¾ã—ã„ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„
            5. ç”Ÿæˆã—ãŸãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ `/tmp/release-notes.md` ã«ä¿å­˜ã—ã¦ãã ã•ã„

            ## æ³¨æ„äº‹é …
            - ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã¯ãªãã€**å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã®å·®åˆ†**ã‚’åˆ†æã—ã¦ãã ã•ã„
            - æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸé–¢æ•°ã€ã‚¯ãƒ©ã‚¹ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç‰¹å®šã—ã¦ãã ã•ã„
            - å‰Šé™¤ã•ã‚ŒãŸæ©Ÿèƒ½ã‚„ç ´å£Šçš„å¤‰æ›´ã‚’æ¤œå‡ºã—ã¦ãã ã•ã„
            - ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€ä¸»è¦ãªå¤‰æ›´ã‚’æ–‡å­¦çš„ã«ç´¹ä»‹ã—ã¦ãã ã•ã„
            - æ—¥æœ¬èªã¨è‹±èªã®ä¸¡æ–¹ã§ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„
            - æœ€å¾Œã«ç”Ÿæˆã—ãŸãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã®å†…å®¹ã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã—ã¦ãã ã•ã„

          # API ã‚­ãƒ¼
          anthropic_api_key: ${{ secrets.ZAI_API_KEY }}

        env:
          # GLM ã«å‘ã‘ã‚‹è¨­å®š
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ZAI_API_KEY }}
          API_TIMEOUT_MS: "3000000"
          ANTHROPIC_DEFAULT_OPUS_MODEL: "glm-4.7"
          ANTHROPIC_DEFAULT_SONNET_MODEL: "glm-4.7"
          ANTHROPIC_DEFAULT_HAIKU_MODEL: "glm-4.5-air"

          # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«æ¸¡ã™ç’°å¢ƒå¤‰æ•°
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ steps.prev-tag.outputs.current_tag }}
          PREVIOUS_TAG: ${{ steps.prev-tag.outputs.previous_tag }}

      - name: Display generated release notes
        if: always()
        run: |
          if [[ -f /tmp/release-notes.md ]]; then
            echo "## ğŸ“ Generated Release Notes"
            echo ""
            cat /tmp/release-notes.md
          else
            echo "No release notes were generated."
          fi

      - name: Create GitHub Release
        if: env.CREATE_GITHUB_RELEASE == 'true' && hashFiles('/tmp/release-notes.md') != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ env.CREATE_AUTO_RELEASE }}" != "true" ]]; then
            echo "CREATE_AUTO_RELEASE is not true. Skipping release creation."
            exit 0
          fi

          if [[ ! -f /tmp/release-notes.md ]]; then
            echo "ERROR: Release notes file not found!"
            exit 1
          fi

          # ãƒªãƒªãƒ¼ã‚¹ã®ä½œæˆ
          gh release create "${{ steps.prev-tag.outputs.current_tag }}" \
            --notes-file /tmp/release-notes.md \
            --title "${{ steps.prev-tag.outputs.current_tag }}" \
            --latest

          echo "âœ… Release created successfully!"

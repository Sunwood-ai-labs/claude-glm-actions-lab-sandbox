name: Auto Release Notes

on:
  push:
    tags:
      - 'v*.*.*'
      - 'V*.*.*'

# 同じタグでは同時に走らないようにする
concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: false

permissions:
  contents: write
  issues: write

jobs:
  create-issue:
    name: Create Release Note Request
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0                    # 全履歴を取得

      - name: Get previous tag
        id: prev-tag
        shell: bash
        run: |
          # タグ名を取得（v/ V プレフィックスを除去）
          CURRENT_TAG="${{ github.ref_name }}"
          CURRENT_VERSION="${CURRENT_TAG#v}"
          CURRENT_VERSION="${CURRENT_VERSION#V}"

          echo "current_tag=${CURRENT_TAG}" >> "$GITHUB_OUTPUT"
          echo "current_version=${CURRENT_VERSION}" >> "$GITHUB_OUTPUT"

          # 前回のタグを取得
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            echo "previous_tag=${PREV_TAG}" >> "$GITHUB_OUTPUT"
            echo "Found previous tag: ${PREV_TAG}"
          else
            echo "previous_tag=" >> "$GITHUB_OUTPUT"
            echo "No previous tag found (first release)"
          fi

      - name: Get code diff
        shell: bash
        run: |
          # 前回のタグがある場合は差分を取得
          if [ -n "${{ steps.prev-tag.outputs.previous_tag }}" ]; then
            echo "Getting diff from ${{ steps.prev-tag.outputs.previous_tag }} to ${{ steps.prev-tag.outputs.current_tag }}..."
            git diff ${{ steps.prev-tag.outputs.previous_tag }}..${{ steps.prev-tag.outputs.current_tag }} --stat > /tmp/diff-stat.txt
            git diff ${{ steps.prev-tag.outputs.previous_tag }}..${{ steps.prev-tag.outputs.current_tag }} > /tmp/diff.txt
            git diff --name-only ${{ steps.prev-tag.outputs.previous_tag }}..${{ steps.prev-tag.outputs.current_tag }} > /tmp/changed-files.txt
          else
            echo "Getting all files for first release..."
            git ls-files > /tmp/changed-files.txt
            echo "No diff available for first release" > /tmp/diff-stat.txt
            echo "First release - no diff" > /tmp/diff.txt
          fi

          echo "=== Changed Files ==="
          cat /tmp/changed-files.txt
          echo ""
          echo "=== Diff Stat ==="
          cat /tmp/diff-stat.txt

      - name: Create issue for release notes
        id: create-issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TITLE="リリースノート生成: ${{ steps.prev-tag.outputs.current_tag }}"

          # Issue本文を作成（統計情報のみ）
          cat << 'EOF' > /tmp/issue-body.md
          @claude リリースノートを生成してください。

          ## リリース情報
          - タグ名: `${CURRENT_TAG}`
          - バージョン: `${CURRENT_VERSION}`
          - 前回のタグ: `${PREVIOUS_TAG}`

          ## 変更統計

          ```
          DIFF_STAT
          ```

          コード差分はコメントとして添付されています。

          ---

          琴音（コトネ）キャラクターで、美しいリリースノートを紡いでください。

          生成後、GitHub Release を作成してください。
          EOF

          # 環境変数とdiff内容を置換
          sed -i "s|\${CURRENT_TAG}|${{ steps.prev-tag.outputs.current_tag }}|g" /tmp/issue-body.md
          sed -i "s|\${CURRENT_VERSION}|${{ steps.prev-tag.outputs.current_version }}|g" /tmp/issue-body.md
          sed -i "s|\${PREVIOUS_TAG}|${{ steps.prev-tag.outputs.previous_tag }}|g" /tmp/issue-body.md

          # diff_statを埋め込み
          diff_stat=$(cat /tmp/diff-stat.txt)
          sed -i "s|DIFF_STAT|$diff_stat|g" /tmp/issue-body.md

          # Issueを作成してURLを取得
          ISSUE_URL=$(gh issue create \
            --title "$TITLE" \
            --body-file /tmp/issue-body.md \
            --label "release-notes")

          echo "issue_url=$ISSUE_URL" >> "$GITHUB_OUTPUT"
          echo "✅ Issue created: $ISSUE_URL"

      - name: Attach diff as comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Issue番号を取得
          ISSUE_NUMBER=$(echo "${{ steps.create-issue.outputs.issue_url }}" | grep -oE '[0-9]+$')

          # diffが大きい場合は分割してコメント
          DIFF_FILE="/tmp/diff.txt"
          DIFF_SIZE=$(wc -c < "$DIFF_FILE")
          MAX_SIZE=50000

          if [ $DIFF_SIZE -le $MAX_SIZE ]; then
            # 小さい場合は1つのコメントで追加
            echo "## コード差分" > /tmp/diff-comment.md
            echo "" >> /tmp/diff-comment.md
            echo '```diff' >> /tmp/diff-comment.md
            cat "$DIFF_FILE" >> /tmp/diff-comment.md
            echo "" >> /tmp/diff-comment.md
            echo '```' >> /tmp/diff-comment.md

            gh issue comment "$ISSUE_NUMBER" --body-file /tmp/diff-comment.md
          else
            # 大きい場合は分割
            echo "Large diff detected, splitting into multiple comments..."

            # 変更ファイル一覧を最初のコメントに
            echo "## コード差分" > /tmp/diff-comment.md
            echo "" >> /tmp/diff-comment.md
            echo "### 変更されたファイル" >> /tmp/diff-comment.md
            echo '```' >> /tmp/diff-comment.md
            cat /tmp/changed-files.txt >> /tmp/diff-comment.md
            echo '```' >> /tmp/diff-comment.md
            echo "" >> /tmp/diff-comment.md
            echo "diff が大きいため分割されています。詳細は以下のコメントを参照してください。" >> /tmp/diff-comment.md

            gh issue comment "$ISSUE_NUMBER" --body-file /tmp/diff-comment.md

            # diffを分割して追加
            split -d -l 1000 "$DIFF_FILE" /tmp/diff-part-

            PART_NUM=1
            for part in /tmp/diff-part-*; do
              echo "## コード差分 (Part $PART_NUM)" > /tmp/part-comment.md
              echo "" >> /tmp/part-comment.md
              echo '```diff' >> /tmp/part-comment.md
              cat "$part" >> /tmp/part-comment.md
              echo "" >> /tmp/part-comment.md
              echo '```' >> /tmp/part-comment.md

              gh issue comment "$ISSUE_NUMBER" --body-file /tmp/part-comment.md
              PART_NUM=$((PART_NUM + 1))
            done
          fi

          echo "✅ Diff attached as comments"

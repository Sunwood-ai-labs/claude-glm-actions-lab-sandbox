name: Auto Release Notes

on:
  push:
    tags:
      - 'v*.*.*'
      - 'V*.*.*'

# åŒã˜ã‚¿ã‚°ã§ã¯åŒæ™‚ã«èµ°ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: false

permissions:
  contents: write
  issues: write

env:
  FAL_KEY: ${{ secrets.FAL_KEY }}
  HEADER_MODE: ${{ vars.HEADER_MODE || 'svg' }}  # fal or svg
  SOURCE_LOCATION: ${{ vars.SOURCE_LOCATION || 'remote' }}  # ã‚½ãƒ¼ã‚¹ã®ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³: local ã¾ãŸã¯ remote
  SOURCE_URL: ${{ vars.SOURCE_URL || 'https://raw.githubusercontent.com/Sunwood-AI-OSS-Hub/claude-glm-actions-lab-sandbox/refs/heads/main/.github/scripts/generate-header.py' }}
  LOCAL_PATH: '.github/scripts/generate-header.py'

jobs:
  generate-header:
    name: Generate Header Image ğŸ¨
    runs-on: ubuntu-latest
    outputs:
      header-path: ${{ steps.generate.outputs.header-path }}
      header-ext: ${{ steps.generate.outputs.header-ext }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install fal-client
        run: |
          pip install fal-client

      - name: Get tag info
        id: tag-info
        run: |
          TAG="${{ github.ref_name }}"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "Detected tag: ${TAG}"

      - name: Generate header image ğŸ±
        id: generate
        env:
          FAL_KEY: ${{ secrets.FAL_KEY }}
          SOURCE_LOCATION: ${{ vars.SOURCE_LOCATION || 'remote' }}
          SOURCE_URL: ${{ vars.SOURCE_URL || 'https://raw.githubusercontent.com/Sunwood-AI-OSS-Hub/claude-glm-actions-lab-sandbox/refs/heads/main/.github/scripts/generate-header.py' }}
          HEADER_MODE: ${{ vars.HEADER_MODE || 'svg' }}
        run: |
          HEADER_DIR="./assets/release-headers"
          mkdir -p "${HEADER_DIR}"

          # HEADER_MODE ã«å¿œã˜ã¦æ‹¡å¼µå­ã¨ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š
          # GitHub Variables ã§ "SVG" ãªã©å¤§æ–‡å­—ã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§æ­£è¦åŒ–ã™ã‚‹
          HEADER_MODE_NORM="$(printf '%s' "${HEADER_MODE:-}" | tr '[:upper:]' '[:lower:]' | tr -d '\r\n\t ' )"
          echo "HEADER_MODE(raw)='${HEADER_MODE:-}' normalized='${HEADER_MODE_NORM}'"

          if [ "$HEADER_MODE_NORM" = "svg" ] || [ "$HEADER_MODE_NORM" = "vector" ]; then
            HEADER_EXT="svg"
            MODE_ARG="--format svg"
            echo "ğŸ¨ Using SVG vector mode..."
          else
            HEADER_EXT="png"
            MODE_ARG=""
            echo "ğŸ–¼ï¸ Using fal.ai PNG mode..."
          fi

          HEADER_PATH="${HEADER_DIR}/header-${{ steps.tag-info.outputs.tag }}.${HEADER_EXT}"

          # SOURCE_LOCATIONã§ãƒ­ãƒ¼ã‚«ãƒ«/ãƒªãƒ¢ãƒ¼ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆãƒ‹ãƒ£ï¼ğŸ±
          if [ "$SOURCE_LOCATION" = "local" ]; then
            # ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
            echo "ğŸ“ Using local script..."
            python3 .github/scripts/generate-header.py \
              --tag "${{ steps.tag-info.outputs.tag }}" \
              --theme auto \
              ${MODE_ARG} \
              --output "${HEADER_PATH}"
          else
            # ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
            echo "ğŸŒ Using remote script..."
            curl -s "${SOURCE_URL}" \
              | python3 - --tag "${{ steps.tag-info.outputs.tag }}" --theme auto ${MODE_ARG} --output "${HEADER_PATH}"
          fi

          echo "header-path=${HEADER_PATH}" >> "$GITHUB_OUTPUT"
          echo "header-ext=${HEADER_EXT}" >> "$GITHUB_OUTPUT"
          echo "âœ… Header image generated: ${HEADER_PATH}"

      - name: Upload header artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-header
          path: ${{ steps.generate.outputs.header-path }}
          retention-days: 30

      - name: Commit and push header image ğŸ±
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          HEADER_PATH="${{ steps.generate.outputs.header-path }}"
          BRANCH_NAME="header-${{ steps.tag-info.outputs.tag }}"

          # Gitè¨­å®š
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ã¦ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
          git checkout -b "${BRANCH_NAME}"

          # ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒã‚’ã‚³ãƒŸãƒƒãƒˆ
          git add "${HEADER_PATH}"
          git commit -m "chore: add header image for ${{ steps.tag-info.outputs.tag }} ğŸ±"

          # ãƒ—ãƒƒã‚·ãƒ¥
          git push origin "${BRANCH_NAME}"

          echo "âœ… Header image committed and pushed: ${HEADER_PATH}"

  create-issue:
    name: Create Release Note Request
    runs-on: ubuntu-latest
    needs: generate-header

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0                    # å…¨å±¥æ­´ã‚’å–å¾—

      - name: Get previous tag
        id: prev-tag
        shell: bash
        run: |
          # ã‚¿ã‚°åã‚’å–å¾—ï¼ˆv/ V ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»ï¼‰
          CURRENT_TAG="${{ github.ref_name }}"
          CURRENT_VERSION="${CURRENT_TAG#v}"
          CURRENT_VERSION="${CURRENT_VERSION#V}"

          echo "current_tag=${CURRENT_TAG}" >> "$GITHUB_OUTPUT"
          echo "current_version=${CURRENT_VERSION}" >> "$GITHUB_OUTPUT"

          # å‰å›ã®ã‚¿ã‚°ã‚’å–å¾—
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            echo "previous_tag=${PREV_TAG}" >> "$GITHUB_OUTPUT"
            echo "Found previous tag: ${PREV_TAG}"
          else
            echo "previous_tag=" >> "$GITHUB_OUTPUT"
            echo "No previous tag found (first release)"
          fi

      - name: Get code diff
        shell: bash
        run: |
          # å‰å›ã®ã‚¿ã‚°ãŒã‚ã‚‹å ´åˆã¯å·®åˆ†ã‚’å–å¾—
          if [ -n "${{ steps.prev-tag.outputs.previous_tag }}" ]; then
            echo "Getting diff from ${{ steps.prev-tag.outputs.previous_tag }} to ${{ steps.prev-tag.outputs.current_tag }}..."
            git diff ${{ steps.prev-tag.outputs.previous_tag }}..${{ steps.prev-tag.outputs.current_tag }} --stat > /tmp/diff-stat.txt
            git diff ${{ steps.prev-tag.outputs.previous_tag }}..${{ steps.prev-tag.outputs.current_tag }} > /tmp/diff.txt
            git diff --name-only ${{ steps.prev-tag.outputs.previous_tag }}..${{ steps.prev-tag.outputs.current_tag }} > /tmp/changed-files.txt
          else
            echo "Getting all files for first release..."
            git ls-files > /tmp/changed-files.txt
            echo "No diff available for first release" > /tmp/diff-stat.txt
            echo "First release - no diff" > /tmp/diff.txt
          fi

          echo "=== Changed Files ==="
          cat /tmp/changed-files.txt
          echo ""
          echo "=== Diff Stat ==="
          cat /tmp/diff-stat.txt

      - name: Create issue for release notes
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_ONIZUKA }}
          HEADER_EXT: ${{ needs.generate-header.outputs.header-ext || 'png' }}
        run: |
          # IMPORTANT:
          # If GH_PAT_ONIZUKA is missing/empty, gh CLI will silently fall back to GITHUB_TOKEN.
          # Events caused by GITHUB_TOKEN do not trigger other workflows, so @claude won't run.
          if [ -z "${{ secrets.GH_PAT_ONIZUKA }}" ]; then
            echo "ERROR: secrets.GH_PAT_ONIZUKA is not set (or empty)."
            echo "Set GH_PAT_ONIZUKA to a PAT (classic) with repo scope (at least Issues) to allow downstream workflow triggers."
            exit 1
          fi

          # Force gh CLI to use the PAT, not the ephemeral GITHUB_TOKEN.
          unset GITHUB_TOKEN
          export GH_TOKEN="${{ secrets.GH_PAT_ONIZUKA }}"

          TITLE="ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆ: ${{ steps.prev-tag.outputs.current_tag }}"

          # diffãŒå¤§ãã„å ´åˆã¯åˆ¶é™
          DIFF_SIZE=$(wc -c < /tmp/diff.txt)
          if [ $DIFF_SIZE -gt 100000 ]; then
            head -c 100000 /tmp/diff.txt > /tmp/diff-truncated.txt
            echo "" >> /tmp/diff-truncated.txt
            echo "... (diff is truncated due to size, see full diff in repository)" >> /tmp/diff-truncated.txt
            mv /tmp/diff-truncated.txt /tmp/diff.txt
          fi

          # Issueæœ¬æ–‡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆï¼ˆä¸€é‡å¼•ç”¨ç¬¦ã§å›²ã‚“ã§å¤‰æ•°å±•é–‹ã‚’é˜²ãï¼‰
          cat > /tmp/issue-template.md << 'TEMPLATEEOF'
          @claude ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          ## ãƒªãƒªãƒ¼ã‚¹æƒ…å ±
          - ã‚¿ã‚°å: `__CURRENT_TAG__`
          - ãƒãƒ¼ã‚¸ãƒ§ãƒ³: `__CURRENT_VERSION__`
          - å‰å›ã®ã‚¿ã‚°: `__PREVIOUS_TAG__`

          ## ğŸ¨ ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒ

          ![Header Image](https://raw.githubusercontent.com/Sunwood-AI-OSS-Hub/claude-glm-actions-lab-sandbox/header-__CURRENT_TAG__/assets/release-headers/header-__CURRENT_TAG__.__HEADER_EXT__)

          ## å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«

          ```
          __CHANGED_FILES__
          ```

          ## å¤‰æ›´çµ±è¨ˆ

          ```
          __DIFF_STAT__
          ```

          ## ã‚³ãƒ¼ãƒ‰å·®åˆ†

          ```diff
          __DIFF_CONTENT__
          ```

          ---

          ç´éŸ³ï¼ˆã‚³ãƒˆãƒï¼‰ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã§ã€ç¾ã—ã„ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç´¡ã„ã§ãã ã•ã„ã€‚

          ## ğŸ“ ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆä½œæˆã®æŒ‡ç¤º

          - **å†’é ­ã«ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒã¨ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¿…ãšå…¥ã‚Œã¦ãã ã•ã„ï¼ˆã©ã¡ã‚‰ã‚‚ä¸­å¤®æƒãˆï¼‰**:
            ```html
            <div align="center">
              <img src="https://raw.githubusercontent.com/Sunwood-AI-OSS-Hub/claude-glm-actions-lab-sandbox/header-__CURRENT_TAG__/assets/release-headers/header-__CURRENT_TAG__.__HEADER_EXT__" alt="Header Image" />
            </div>
            <div align="center">
              <h2>__CURRENT_TAG__ ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ</h2>
            </div>
            ```
          - **ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒã¨ã‚¿ã‚¤ãƒˆãƒ«ã®é–“ã«åŒºåˆ‡ã‚Šç·šï¼ˆ`---` / `***`ï¼‰ã¯ä¸è¦ã§ã™**
          - ç´éŸ³ï¼ˆã‚³ãƒˆãƒï¼‰ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ã—ã¦ã€æ–‡å­¦çš„ã§ä¸å¯§ãªè¨€è‘‰é£ã„ã§ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’æ›¸ã„ã¦ãã ã•ã„

          ç”Ÿæˆå¾Œã€GitHub Release ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

          ## ğŸš¨ é‡è¦: Release ä½œæˆã®ãƒ«ãƒ¼ãƒ«

          - Release ã®æœ¬æ–‡ã¯å¿…ãšãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¦ `--notes-file` ã§æ¸¡ã—ã¦ãã ã•ã„ï¼ˆ`--notes` / `$(cat ...)` / heredoc ã§æœ¬æ–‡ã‚’ã‚³ãƒãƒ³ãƒ‰ã«åŸ‹ã‚è¾¼ã¾ãªã„ï¼‰
          - Issue ã‚³ãƒ¡ãƒ³ãƒˆã«ã¯é•·ã„ã‚³ãƒãƒ³ãƒ‰ä¾‹ã¯è²¼ã‚‰ãšã€Release URL ã¨è¦ç‚¹ã ã‘ã‚’å ±å‘Šã—ã¦ãã ã•ã„
          TEMPLATEEOF

          # ã‚¿ã‚°æƒ…å ±ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ç½®æ›ï¼ˆå€¤ã‚’ç›´æ¥åŸ‹ã‚è¾¼ã¿ï¼‰
          sed -i "s|__CURRENT_TAG__|${{ steps.prev-tag.outputs.current_tag }}|g" /tmp/issue-template.md
          sed -i "s|__CURRENT_VERSION__|${{ steps.prev-tag.outputs.current_version }}|g" /tmp/issue-template.md
          sed -i "s|__PREVIOUS_TAG__|${{ steps.prev-tag.outputs.previous_tag }}|g" /tmp/issue-template.md
          sed -i "s|__HEADER_EXT__|${HEADER_EXT}|g" /tmp/issue-template.md

          # ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’åŸ‹ã‚è¾¼ã¿ï¼ˆr ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ï¼‰
          # ã“ã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ GitHub Actions å¼ã®ã‚ˆã†ãªæ–‡å­—åˆ—ã‚„ `` ` `` ãªã©ã®ç‰¹æ®Šæ–‡å­—ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŒã€
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€ã®ã§ã‚·ã‚§ãƒ«å¤‰æ•°å±•é–‹ã®å½±éŸ¿ã‚’å—ã‘ãªã„
          sed -i "/__CHANGED_FILES__/r /tmp/changed-files.txt" /tmp/issue-template.md
          sed -i "/__CHANGED_FILES__/d" /tmp/issue-template.md

          sed -i "/__DIFF_STAT__/r /tmp/diff-stat.txt" /tmp/issue-template.md
          sed -i "/__DIFF_STAT__/d" /tmp/issue-template.md

          sed -i "/__DIFF_CONTENT__/r /tmp/diff.txt" /tmp/issue-template.md
          sed -i "/__DIFF_CONTENT__/d" /tmp/issue-template.md

          # Issueã‚’ä½œæˆï¼ˆ--body-file ã‚’ä½¿ç”¨ã—ã¦ã€ã‚·ã‚§ãƒ«ã®ãƒ¡ã‚¿æ–‡å­—å±•é–‹ã‚’å›é¿ï¼‰
          ISSUE_URL=$(gh issue create \
            --repo "${GITHUB_REPOSITORY}" \
            --title "$TITLE" \
            --body-file /tmp/issue-template.md)

          echo "âœ… Issue created: $ISSUE_URL"

          # NOTE:
          # We intentionally do NOT add an extra @claude comment here.
          # The issue body already contains @claude, and a comment would cause double-trigger
          # (issues:opened + issue_comment:created) and concurrency cancellations.

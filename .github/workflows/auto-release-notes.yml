name: Auto Release Notes

on:
  push:
    tags:
      - 'v*.*.*'
      - 'V*.*.*'

# åŒã˜ã‚¿ã‚°ã§ã¯åŒæ™‚ã«èµ°ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: false

permissions:
  contents: write
  issues: write

jobs:
  create-issue:
    name: Create Release Note Request
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0                    # å…¨å±¥æ­´ã‚’å–å¾—

      - name: Get previous tag
        id: prev-tag
        shell: bash
        run: |
          # ã‚¿ã‚°åã‚’å–å¾—ï¼ˆv/ V ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»ï¼‰
          CURRENT_TAG="${{ github.ref_name }}"
          CURRENT_VERSION="${CURRENT_TAG#v}"
          CURRENT_VERSION="${CURRENT_VERSION#V}"

          echo "current_tag=${CURRENT_TAG}" >> "$GITHUB_OUTPUT"
          echo "current_version=${CURRENT_VERSION}" >> "$GITHUB_OUTPUT"

          # å‰å›ã®ã‚¿ã‚°ã‚’å–å¾—
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            echo "previous_tag=${PREV_TAG}" >> "$GITHUB_OUTPUT"
            echo "Found previous tag: ${PREV_TAG}"
          else
            echo "previous_tag=" >> "$GITHUB_OUTPUT"
            echo "No previous tag found (first release)"
          fi

      - name: Get code diff
        shell: bash
        run: |
          # å‰å›ã®ã‚¿ã‚°ãŒã‚ã‚‹å ´åˆã¯å·®åˆ†ã‚’å–å¾—
          if [ -n "${{ steps.prev-tag.outputs.previous_tag }}" ]; then
            echo "Getting diff from ${{ steps.prev-tag.outputs.previous_tag }} to ${{ steps.prev-tag.outputs.current_tag }}..."
            git diff ${{ steps.prev-tag.outputs.previous_tag }}..${{ steps.prev-tag.outputs.current_tag }} --stat > /tmp/diff-stat.txt
            git diff ${{ steps.prev-tag.outputs.previous_tag }}..${{ steps.prev-tag.outputs.current_tag }} > /tmp/diff.txt
            git diff --name-only ${{ steps.prev-tag.outputs.previous_tag }}..${{ steps.prev-tag.outputs.current_tag }} > /tmp/changed-files.txt
          else
            echo "Getting all files for first release..."
            git ls-files > /tmp/changed-files.txt
            echo "No diff available for first release" > /tmp/diff-stat.txt
            echo "First release - no diff" > /tmp/diff.txt
          fi

          echo "=== Changed Files ==="
          cat /tmp/changed-files.txt
          echo ""
          echo "=== Diff Stat ==="
          cat /tmp/diff-stat.txt

      - name: Create issue for release notes
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TITLE="ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆ: ${{ steps.prev-tag.outputs.current_tag }}"

          # diffãŒå¤§ãã„å ´åˆã¯åˆ¶é™
          DIFF_SIZE=$(wc -c < /tmp/diff.txt)
          if [ $DIFF_SIZE -gt 100000 ]; then
            head -c 100000 /tmp/diff.txt > /tmp/diff-truncated.txt
            echo "" >> /tmp/diff-truncated.txt
            echo "... (diff is truncated due to size, see full diff in repository)" >> /tmp/diff-truncated.txt
            mv /tmp/diff-truncated.txt /tmp/diff.txt
          fi

          # Issueæœ¬æ–‡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆï¼ˆä¸€é‡å¼•ç”¨ç¬¦ã§å›²ã‚“ã§å¤‰æ•°å±•é–‹ã‚’é˜²ãï¼‰
          cat > /tmp/issue-template.md << 'TEMPLATEEOF'
          @claude ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          ## ãƒªãƒªãƒ¼ã‚¹æƒ…å ±
          - ã‚¿ã‚°å: `__CURRENT_TAG__`
          - ãƒãƒ¼ã‚¸ãƒ§ãƒ³: `__CURRENT_VERSION__`
          - å‰å›ã®ã‚¿ã‚°: `__PREVIOUS_TAG__`

          ## å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«

          ```
          __CHANGED_FILES__
          ```

          ## å¤‰æ›´çµ±è¨ˆ

          ```
          __DIFF_STAT__
          ```

          ## ã‚³ãƒ¼ãƒ‰å·®åˆ†

          ```diff
          __DIFF_CONTENT__
          ```

          ---

          ç´éŸ³ï¼ˆã‚³ãƒˆãƒï¼‰ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã§ã€ç¾ã—ã„ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç´¡ã„ã§ãã ã•ã„ã€‚

          ç”Ÿæˆå¾Œã€GitHub Release ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

          ## ğŸš¨ é‡è¦: Release ä½œæˆã®ãƒ«ãƒ¼ãƒ«

          - Release ã®æœ¬æ–‡ã¯å¿…ãšãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¦ `--notes-file` ã§æ¸¡ã—ã¦ãã ã•ã„ï¼ˆ`--notes` / `$(cat ...)` / heredoc ã§æœ¬æ–‡ã‚’ã‚³ãƒãƒ³ãƒ‰ã«åŸ‹ã‚è¾¼ã¾ãªã„ï¼‰
          - Issue ã‚³ãƒ¡ãƒ³ãƒˆã«ã¯é•·ã„ã‚³ãƒãƒ³ãƒ‰ä¾‹ã¯è²¼ã‚‰ãšã€Release URL ã¨è¦ç‚¹ã ã‘ã‚’å ±å‘Šã—ã¦ãã ã•ã„
          TEMPLATEEOF

          # ã‚¿ã‚°æƒ…å ±ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ç½®æ›ï¼ˆå€¤ã‚’ç›´æ¥åŸ‹ã‚è¾¼ã¿ï¼‰
          sed -i "s|__CURRENT_TAG__|${{ steps.prev-tag.outputs.current_tag }}|g" /tmp/issue-template.md
          sed -i "s|__CURRENT_VERSION__|${{ steps.prev-tag.outputs.current_version }}|g" /tmp/issue-template.md
          sed -i "s|__PREVIOUS_TAG__|${{ steps.prev-tag.outputs.previous_tag }}|g" /tmp/issue-template.md

          # ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’åŸ‹ã‚è¾¼ã¿ï¼ˆr ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ï¼‰
          # ã“ã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ GitHub Actions å¼ã®ã‚ˆã†ãªæ–‡å­—åˆ—ã‚„ `` ` `` ãªã©ã®ç‰¹æ®Šæ–‡å­—ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŒã€
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€ã®ã§ã‚·ã‚§ãƒ«å¤‰æ•°å±•é–‹ã®å½±éŸ¿ã‚’å—ã‘ãªã„
          sed -i "/__CHANGED_FILES__/r /tmp/changed-files.txt" /tmp/issue-template.md
          sed -i "/__CHANGED_FILES__/d" /tmp/issue-template.md

          sed -i "/__DIFF_STAT__/r /tmp/diff-stat.txt" /tmp/issue-template.md
          sed -i "/__DIFF_STAT__/d" /tmp/issue-template.md

          sed -i "/__DIFF_CONTENT__/r /tmp/diff.txt" /tmp/issue-template.md
          sed -i "/__DIFF_CONTENT__/d" /tmp/issue-template.md

          # Issueã‚’ä½œæˆï¼ˆ--body-file ã‚’ä½¿ç”¨ã—ã¦ã€ã‚·ã‚§ãƒ«ã®ãƒ¡ã‚¿æ–‡å­—å±•é–‹ã‚’å›é¿ï¼‰
          ISSUE_URL=$(gh issue create \
            --title "$TITLE" \
            --body-file /tmp/issue-template.md)

          echo "âœ… Issue created: $ISSUE_URL"

          # Issueç•ªå·ã‚’å–å¾—
          ISSUE_NUMBER=$(echo "$ISSUE_URL" | grep -oE '[0-9]+$')

          # @claude ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¦ responder ã‚’ãƒˆãƒªã‚¬ãƒ¼
          # github-actions[bot] ã«ã‚ˆã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã¯ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œãªã„ãŸã‚ PAT ã‚’ä½¿ç”¨
          export GH_TOKEN="${{ secrets.GH_PAT_ONIZUKA }}"
          gh issue comment "$ISSUE_NUMBER" --body "@claude"

          echo "âœ… @claude comment added to trigger responder"

name: Auto Release Notes

on:
  push:
    tags:
      - 'v*.*.*'
      - 'V*.*.*'

# Âêå„Åò„Çø„Ç∞„Åß„ÅØÂêåÊôÇ„Å´Ëµ∞„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã
concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: false

permissions:
  contents: write
  issues: write

env:
  FAL_KEY: ${{ secrets.FAL_KEY }}
  HEADER_MODE: ${{ vars.HEADER_MODE || 'fal' }}  # fal or svg
  SOURCE_LOCATION: ${{ vars.SOURCE_LOCATION || 'remote' }}  # „ÇΩ„Éº„Çπ„ÅÆ„É≠„Ç±„Éº„Ç∑„Éß„É≥: local „Åæ„Åü„ÅØ remote
  SOURCE_URL: ${{ vars.SOURCE_URL || 'https://raw.githubusercontent.com/Sunwood-AI-OSS-Hub/claude-glm-actions-lab-sandbox/refs/heads/main/.github/scripts/generate-header.py' }}
  LOCAL_PATH: '.github/scripts/generate-header.py'

jobs:
  generate-header:
    name: Generate Header Image üé®
    runs-on: ubuntu-latest
    outputs:
      header-path: ${{ steps.generate.outputs.header-path }}
      header-ext: ${{ steps.generate.outputs.header-ext }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install fal-client
        run: |
          pip install fal-client

      - name: Get tag info
        id: tag-info
        run: |
          TAG="${{ github.ref_name }}"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "Detected tag: ${TAG}"

      - name: Generate header image üê±
        id: generate
        env:
          FAL_KEY: ${{ secrets.FAL_KEY }}
          SOURCE_LOCATION: ${{ vars.SOURCE_LOCATION || 'remote' }}
          SOURCE_URL: ${{ vars.SOURCE_URL || 'https://raw.githubusercontent.com/Sunwood-AI-OSS-Hub/claude-glm-actions-lab-sandbox/refs/heads/main/.github/scripts/generate-header.py' }}
          HEADER_MODE: ${{ vars.HEADER_MODE || 'svg' }}
        run: |
          HEADER_DIR="./assets/release-headers"
          mkdir -p "${HEADER_DIR}"

          # HEADER_MODE „Å´Âøú„Åò„Å¶Êã°ÂºµÂ≠ê„Å®„É¢„Éº„Éâ„ÇíË®≠ÂÆö
          if [ "$HEADER_MODE" = "svg" ]; then
            HEADER_EXT="svg"
            MODE_ARG="--format svg"
            echo "üé® Using SVG vector mode..."
          else
            HEADER_EXT="png"
            MODE_ARG=""
            echo "üñºÔ∏è Using fal.ai PNG mode..."
          fi

          HEADER_PATH="${HEADER_DIR}/header-${{ steps.tag-info.outputs.tag }}.${HEADER_EXT}"

          # SOURCE_LOCATION„Åß„É≠„Éº„Ç´„É´/„É™„É¢„Éº„Éà„ÇíÂàá„ÇäÊõø„Åà„Éã„É£ÔºÅüê±
          if [ "$SOURCE_LOCATION" = "local" ]; then
            # „É≠„Éº„Ç´„É´„Çπ„ÇØ„É™„Éó„Éà„ÇíÂÆüË°å
            echo "üìÅ Using local script..."
            python3 .github/scripts/generate-header.py \
              --tag "${{ steps.tag-info.outputs.tag }}" \
              --theme auto \
              ${MODE_ARG} \
              --output "${HEADER_PATH}"
          else
            # „É™„É¢„Éº„Éà„Çπ„ÇØ„É™„Éó„Éà„ÇíÂÆüË°åÔºà„Éá„Éï„Ç©„É´„ÉàÔºâ
            echo "üåê Using remote script..."
            curl -s "${SOURCE_URL}" \
              | python3 - --tag "${{ steps.tag-info.outputs.tag }}" --theme auto ${MODE_ARG} --output "${HEADER_PATH}"
          fi

          echo "header-path=${HEADER_PATH}" >> "$GITHUB_OUTPUT"
          echo "header-ext=${HEADER_EXT}" >> "$GITHUB_OUTPUT"
          echo "‚úÖ Header image generated: ${HEADER_PATH}"

      - name: Upload header artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-header
          path: ${{ steps.generate.outputs.header-path }}
          retention-days: 30

      - name: Commit and push header image üê±
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          HEADER_PATH="${{ steps.generate.outputs.header-path }}"
          BRANCH_NAME="header-${{ steps.tag-info.outputs.tag }}"

          # GitË®≠ÂÆö
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # „Éñ„É©„É≥„ÉÅ„Çí‰ΩúÊàê„Åó„Å¶„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
          git checkout -b "${BRANCH_NAME}"

          # „Éò„ÉÉ„ÉÄ„ÉºÁîªÂÉè„Çí„Ç≥„Éü„ÉÉ„Éà
          git add "${HEADER_PATH}"
          git commit -m "chore: add header image for ${{ steps.tag-info.outputs.tag }} üê±"

          # „Éó„ÉÉ„Ç∑„É•
          git push origin "${BRANCH_NAME}"

          echo "‚úÖ Header image committed and pushed: ${HEADER_PATH}"

  create-issue:
    name: Create Release Note Request
    runs-on: ubuntu-latest
    needs: generate-header

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0                    # ÂÖ®Â±•Ê≠¥„ÇíÂèñÂæó

      - name: Get previous tag
        id: prev-tag
        shell: bash
        run: |
          # „Çø„Ç∞Âêç„ÇíÂèñÂæóÔºàv/ V „Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„ÇíÈô§ÂéªÔºâ
          CURRENT_TAG="${{ github.ref_name }}"
          CURRENT_VERSION="${CURRENT_TAG#v}"
          CURRENT_VERSION="${CURRENT_VERSION#V}"

          echo "current_tag=${CURRENT_TAG}" >> "$GITHUB_OUTPUT"
          echo "current_version=${CURRENT_VERSION}" >> "$GITHUB_OUTPUT"

          # ÂâçÂõû„ÅÆ„Çø„Ç∞„ÇíÂèñÂæó
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            echo "previous_tag=${PREV_TAG}" >> "$GITHUB_OUTPUT"
            echo "Found previous tag: ${PREV_TAG}"
          else
            echo "previous_tag=" >> "$GITHUB_OUTPUT"
            echo "No previous tag found (first release)"
          fi

      - name: Get code diff
        shell: bash
        run: |
          # ÂâçÂõû„ÅÆ„Çø„Ç∞„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÂ∑ÆÂàÜ„ÇíÂèñÂæó
          if [ -n "${{ steps.prev-tag.outputs.previous_tag }}" ]; then
            echo "Getting diff from ${{ steps.prev-tag.outputs.previous_tag }} to ${{ steps.prev-tag.outputs.current_tag }}..."
            git diff ${{ steps.prev-tag.outputs.previous_tag }}..${{ steps.prev-tag.outputs.current_tag }} --stat > /tmp/diff-stat.txt
            git diff ${{ steps.prev-tag.outputs.previous_tag }}..${{ steps.prev-tag.outputs.current_tag }} > /tmp/diff.txt
            git diff --name-only ${{ steps.prev-tag.outputs.previous_tag }}..${{ steps.prev-tag.outputs.current_tag }} > /tmp/changed-files.txt
          else
            echo "Getting all files for first release..."
            git ls-files > /tmp/changed-files.txt
            echo "No diff available for first release" > /tmp/diff-stat.txt
            echo "First release - no diff" > /tmp/diff.txt
          fi

          echo "=== Changed Files ==="
          cat /tmp/changed-files.txt
          echo ""
          echo "=== Diff Stat ==="
          cat /tmp/diff-stat.txt

      - name: Create issue for release notes
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_ONIZUKA }}
          HEADER_EXT: ${{ needs.generate-header.outputs.header-ext || 'png' }}
        run: |
          # IMPORTANT:
          # If GH_PAT_ONIZUKA is missing/empty, gh CLI will silently fall back to GITHUB_TOKEN.
          # Events caused by GITHUB_TOKEN do not trigger other workflows, so @claude won't run.
          if [ -z "${{ secrets.GH_PAT_ONIZUKA }}" ]; then
            echo "ERROR: secrets.GH_PAT_ONIZUKA is not set (or empty)."
            echo "Set GH_PAT_ONIZUKA to a PAT (classic) with repo scope (at least Issues) to allow downstream workflow triggers."
            exit 1
          fi

          # Force gh CLI to use the PAT, not the ephemeral GITHUB_TOKEN.
          unset GITHUB_TOKEN
          export GH_TOKEN="${{ secrets.GH_PAT_ONIZUKA }}"

          TITLE="„É™„É™„Éº„Çπ„Éé„Éº„ÉàÁîüÊàê: ${{ steps.prev-tag.outputs.current_tag }}"

          # diff„ÅåÂ§ß„Åç„ÅÑÂ†¥Âêà„ÅØÂà∂Èôê
          DIFF_SIZE=$(wc -c < /tmp/diff.txt)
          if [ $DIFF_SIZE -gt 100000 ]; then
            head -c 100000 /tmp/diff.txt > /tmp/diff-truncated.txt
            echo "" >> /tmp/diff-truncated.txt
            echo "... (diff is truncated due to size, see full diff in repository)" >> /tmp/diff-truncated.txt
            mv /tmp/diff-truncated.txt /tmp/diff.txt
          fi

          # IssueÊú¨Êñá„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰ΩúÊàêÔºà‰∏ÄÈáçÂºïÁî®Á¨¶„ÅßÂõ≤„Çì„ÅßÂ§âÊï∞Â±ïÈñã„ÇíÈò≤„ÅêÔºâ
          cat > /tmp/issue-template.md << 'TEMPLATEEOF'
          @claude „É™„É™„Éº„Çπ„Éé„Éº„Éà„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

          ## „É™„É™„Éº„ÇπÊÉÖÂ†±
          - „Çø„Ç∞Âêç: `__CURRENT_TAG__`
          - „Éê„Éº„Ç∏„Éß„É≥: `__CURRENT_VERSION__`
          - ÂâçÂõû„ÅÆ„Çø„Ç∞: `__PREVIOUS_TAG__`

          ## üé® „Éò„ÉÉ„ÉÄ„ÉºÁîªÂÉè

          ![Header Image](https://raw.githubusercontent.com/Sunwood-AI-OSS-Hub/claude-glm-actions-lab-sandbox/header-__CURRENT_TAG__/assets/release-headers/header-__CURRENT_TAG__.__HEADER_EXT__)

          ## Â§âÊõ¥„Åï„Çå„Åü„Éï„Ç°„Ç§„É´

          ```
          __CHANGED_FILES__
          ```

          ## Â§âÊõ¥Áµ±Ë®à

          ```
          __DIFF_STAT__
          ```

          ## „Ç≥„Éº„ÉâÂ∑ÆÂàÜ

          ```diff
          __DIFF_CONTENT__
          ```

          ---

          Áê¥Èü≥Ôºà„Ç≥„Éà„ÉçÔºâ„Ç≠„É£„É©„ÇØ„Çø„Éº„Åß„ÄÅÁæé„Åó„ÅÑ„É™„É™„Éº„Çπ„Éé„Éº„Éà„ÇíÁ¥°„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ

          ## üìù „É™„É™„Éº„Çπ„Éé„Éº„Éà‰ΩúÊàê„ÅÆÊåáÁ§∫

          - **ÂÜíÈ†≠„Å´„Éò„ÉÉ„ÉÄ„ÉºÁîªÂÉè„ÇíÂøÖ„ÅöÂüã„ÇÅËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ**:
            ```markdown
            ![Header Image](https://raw.githubusercontent.com/Sunwood-AI-OSS-Hub/claude-glm-actions-lab-sandbox/header-__CURRENT_TAG__/assets/release-headers/header-__CURRENT_TAG__.__HEADER_EXT__)
            ```
          - „Éò„ÉÉ„ÉÄ„ÉºÁîªÂÉè„ÅÆ‰∏ã„Å´„ÄÅÁæé„Åó„ÅÑÂå∫Âàá„ÇäÁ∑ö„ÇÑË£ÖÈ£æ„ÇíÂä†„Åà„Å¶„Åè„Å†„Åï„ÅÑ
          - Áê¥Èü≥Ôºà„Ç≥„Éà„ÉçÔºâ„ÅÆ„Ç≠„É£„É©„ÇØ„Çø„Éº„Å®„Åó„Å¶„ÄÅÊñáÂ≠¶ÁöÑ„Åß‰∏ÅÂØß„Å™Ë®ÄËëâÈÅ£„ÅÑ„Åß„É™„É™„Éº„Çπ„Éé„Éº„Éà„ÇíÊõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ

          ÁîüÊàêÂæå„ÄÅGitHub Release „Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

          ## üö® ÈáçË¶Å: Release ‰ΩúÊàê„ÅÆ„É´„Éº„É´

          - Release „ÅÆÊú¨Êñá„ÅØÂøÖ„Åö„Éï„Ç°„Ç§„É´„Å´‰øùÂ≠ò„Åó„Å¶ `--notes-file` „ÅßÊ∏°„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà`--notes` / `$(cat ...)` / heredoc „ÅßÊú¨Êñá„Çí„Ç≥„Éû„É≥„Éâ„Å´Âüã„ÇÅËæº„Åæ„Å™„ÅÑÔºâ
          - Issue „Ç≥„É°„É≥„Éà„Å´„ÅØÈï∑„ÅÑ„Ç≥„Éû„É≥„Éâ‰æã„ÅØË≤º„Çâ„Åö„ÄÅRelease URL „Å®Ë¶ÅÁÇπ„Å†„Åë„ÇíÂ†±Âëä„Åó„Å¶„Åè„Å†„Åï„ÅÑ
          TEMPLATEEOF

          # „Çø„Ç∞ÊÉÖÂ†±„ÅÆ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÇíÁΩÆÊèõÔºàÂÄ§„ÇíÁõ¥Êé•Âüã„ÇÅËæº„ÅøÔºâ
          sed -i "s|__CURRENT_TAG__|${{ steps.prev-tag.outputs.current_tag }}|g" /tmp/issue-template.md
          sed -i "s|__CURRENT_VERSION__|${{ steps.prev-tag.outputs.current_version }}|g" /tmp/issue-template.md
          sed -i "s|__PREVIOUS_TAG__|${{ steps.prev-tag.outputs.previous_tag }}|g" /tmp/issue-template.md
          sed -i "s|__HEADER_EXT__|${HEADER_EXT}|g" /tmp/issue-template.md

          # „Éï„Ç°„Ç§„É´ÂÜÖÂÆπ„ÇíÂüã„ÇÅËæº„ÅøÔºàr „Ç≥„Éû„É≥„Éâ„Çí‰ΩøÁî®Ôºâ
          # „Åì„Çå„Çâ„ÅÆ„Éï„Ç°„Ç§„É´„Å´„ÅØ GitHub Actions Âºè„ÅÆ„Çà„ÅÜ„Å™ÊñáÂ≠óÂàó„ÇÑ `` ` `` „Å™„Å©„ÅÆÁâπÊÆäÊñáÂ≠ó„ÅåÂê´„Åæ„Çå„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„Åå„ÄÅ
          # „Éï„Ç°„Ç§„É´„Åã„ÇâË™≠„ÅøËæº„ÇÄ„ÅÆ„Åß„Ç∑„Çß„É´Â§âÊï∞Â±ïÈñã„ÅÆÂΩ±Èüø„ÇíÂèó„Åë„Å™„ÅÑ
          sed -i "/__CHANGED_FILES__/r /tmp/changed-files.txt" /tmp/issue-template.md
          sed -i "/__CHANGED_FILES__/d" /tmp/issue-template.md

          sed -i "/__DIFF_STAT__/r /tmp/diff-stat.txt" /tmp/issue-template.md
          sed -i "/__DIFF_STAT__/d" /tmp/issue-template.md

          sed -i "/__DIFF_CONTENT__/r /tmp/diff.txt" /tmp/issue-template.md
          sed -i "/__DIFF_CONTENT__/d" /tmp/issue-template.md

          # Issue„Çí‰ΩúÊàêÔºà--body-file „Çí‰ΩøÁî®„Åó„Å¶„ÄÅ„Ç∑„Çß„É´„ÅÆ„É°„ÇøÊñáÂ≠óÂ±ïÈñã„ÇíÂõûÈÅøÔºâ
          ISSUE_URL=$(gh issue create \
            --repo "${GITHUB_REPOSITORY}" \
            --title "$TITLE" \
            --body-file /tmp/issue-template.md)

          echo "‚úÖ Issue created: $ISSUE_URL"

          # IssueÁï™Âè∑„ÇíÂèñÂæó
          ISSUE_NUMBER=$(echo "$ISSUE_URL" | grep -oE '[0-9]+$')

          # @claude „É°„É≥„Ç∑„Éß„É≥„ÇíËøΩÂä†„Åó„Å¶ responder „Çí„Éà„É™„Ç¨„Éº
          # github-actions[bot] „Å´„Çà„Çã„Ç≥„É°„É≥„Éà„ÅØ„Éà„É™„Ç¨„Éº„Åï„Çå„Å™„ÅÑ„Åü„ÇÅ PAT „Çí‰ΩøÁî®
          gh issue comment \
            --repo "${GITHUB_REPOSITORY}" \
            "$ISSUE_NUMBER" \
            --body "@claude"

          echo "‚úÖ @claude comment added to trigger responder"
